name: Regress

on: [workflow_dispatch, pull_request, push]

jobs:
  spelling:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: fjcaetano/mint-action@v1.0.2
        with: { package: fromkk/SpellChecker }
      - name: Check spelling
        run: sh .github/scripts/checkSpell.sh

  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - uses: maxim-lobanov/setup-xcode@v1
        with: { xcode-version: '14.1' }
      - name: Build Rugby
        run: |
          swift build -c release
          path=`swift build -c release --show-bin-path`
          strip -rSTx "$path/rugby"
          echo "rugby_path=$path/rugby" >> $GITHUB_ENV
          swift run rugby --version
      - uses: actions/upload-artifact@v3
        with:
          name: rugby
          path: ${{ env.rugby_path }}

  install:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Rugby
        run: |
          mkdir bin && cd bin
          git fetch --tags && git fetch --prune --unshallow || true
          tag=$(git describe --abbrev=0 --tags)
          curl -LO "https://github.com/swiftyfinch/Rugby/releases/download/$tag/x86_64.zip"
          unzip x86_64.zip
          chmod +x rugby && echo `pwd` >> $GITHUB_PATH
      - run: rugby -h
